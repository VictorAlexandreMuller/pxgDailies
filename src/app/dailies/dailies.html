<div class="dailies-page" *ngIf="db as data; else loading">
  <div class="bg"></div>

  <!-- NAVBAR FIXA -->
  <header class="topbar topbar-fixed">
    <div class="left">
      <div class="title">PXG Dailies</div>
      <div class="sub">
        <span><strong>Usuário: </strong>{{ data.profile.displayName }}</span>
        <span class="dot">•</span>
        <span><strong>Sync Code: </strong><code>{{ syncCode }}</code></span>
      </div>
    </div>

    <div class="right">
      <button type="button" class="btn ghost" (click)="exportJsonDownload()">
        Exportar (Download)
      </button>
      <button type="button" class="btn ghost" (click)="exportJsonClipboard()">
        Exportar (Copiar)
      </button>

      <label class="btn ghost import-btn" title="Importar JSON">
        <input type="file" accept="application/json" (change)="onImportFileSelected($event)" />
        Importar JSON
      </label>

      <button type="button" class="btn primary" (click)="logout()">Sair</button>
    </div>
  </header>

  <!-- CONTEÚDO (com espaçamento para não ficar por baixo da navbar) -->
  <main class="shell">
    <section class="glass">
      <div class="glass-inner">
        <section class="error" *ngIf="importError">
          {{ importError }}
        </section>

        <section class="add">
          <input
            type="text"
            placeholder="Character name..."
            [(ngModel)]="newCharacterName"
            (keyup.enter)="addCharacter()"
          />
          <button type="button" class="btn" (click)="addCharacter()">Adicionar Boneco</button>
        </section>

        <section class="list" *ngIf="data.characters.length; else empty">
          <nav class="tabs">
            <button
              type="button"
              class="tab"
              *ngFor="let c of data.characters"
              [class.active]="c.id === activeCharacterId"
              (click)="selectCharacter(c.id)"
            >
              <img class="tab-character" src="/icons/character.png" alt="character" />
              <span class="tab-name">{{ c.name }}</span>

              <img
                class="tab-delete"
                src="/icons/delete.png"
                alt="delete"
                title="Remover boneco"
                (click)="$event.stopPropagation(); removeCharacter(c.id)"
              />
            </button>
          </nav>

          <article class="card" *ngIf="activeCharacter as c">
            <div class="columns">
              <div class="col" *ngFor="let p of periods">
                <div class="col-head">
                  <h3>{{ periodLabel(p) }}</h3>
                  <button
                    type="button"
                    class="icon-btn add-btn"
                    (click)="addTask(c.id, p)"
                    title="Adicionar task"
                  >
                    <img src="/icons/add2.png" alt="add" />
                  </button>
                </div>

                <!-- CONCLUÍDAS dentro do card do período (abaixo do título, acima das tasks) -->
                <section class="done-panel done-inside" *ngIf="tasksOf(c, p).length">
                  <button type="button" class="done-toggle" (click)="toggleDonePanel(p)">
                    <span class="caret" [class.open]="donePanelOpen[p]">›</span>
                    <span class="done-title">Concluídas</span>
                    <span class="done-count">
                      {{ doneTasksOfPeriod(c, p).length }}/{{ tasksOf(c, p).length }}
                    </span>

                  </button>

                  <div class="done-body" *ngIf="donePanelOpen[p]">
                    <div class="done-item" *ngFor="let t of doneTasksOfPeriod(c, p)">
                      <div class="task-row done">
                        <div class="task-title" [title]="t.title">{{ t.title }}</div>

                        <div class="task-actions">
                          <!-- desmarcar: volta para a coluna automaticamente -->
                          <button
                            type="button"
                            class="icon-btn check-btn on"
                            (click)="toggleDone(c.id, t.id)"
                            title="Desmarcar"
                          >
                            <span class="check-icon" aria-hidden="true"></span>
                          </button>

                          <!-- opcional: manter editar/excluir também aqui -->
                          <button
                            type="button"
                            class="icon-btn"
                            (click)="editTask(c.id, t.id)"
                            title="Editar"
                          >
                            <img src="/icons/edit.png" alt="edit" />
                          </button>

                          <button
                            type="button"
                            class="icon-btn"
                            (click)="deleteTask(c.id, t.id)"
                            title="Excluir"
                          >
                            <img src="/icons/delete.png" alt="delete" />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- TASKS ABERTAS do período -->
                <div class="task" *ngFor="let t of openTasksOf(c, p)">
                  <div class="task-row" [class.done]="isDoneNow(t)" [class.doing]="isDoingNow(t)">
                    <div class="task-title" [title]="t.title">{{ t.title }}</div>

                    <div class="task-actions">
                      <button
                        type="button"
                        class="icon-btn check-btn"
                        [class.on]="isDoneNow(t)"
                        (click)="toggleDone(c.id, t.id)"
                        title="Feito"
                      >
                        <span class="check-icon" aria-hidden="true"></span>
                      </button>

                      <button
                        type="button"
                        class="icon-btn"
                        (click)="startFocusCooldown(c.id, t)"
                        title="Fazendo"
                        [disabled]="isDoneNow(t) || isFocusCoolingDown(t.id)"
                        [title]="isFocusCoolingDown(t.id) ? ('Cooldown: ' + (focusCooldownLeft(t.id)) + 's') : 'Fazendo'"
                      >
                        <img src="/icons/focus.png" alt="doing" />
                      </button>

                      <button
                        type="button"
                        class="icon-btn"
                        (click)="editTask(c.id, t.id)"
                        title="Editar"
                      >
                        <img src="/icons/edit.png" alt="edit" />
                      </button>

                      <button
                        type="button"
                        class="icon-btn"
                        (click)="deleteTask(c.id, t.id)"
                        title="Excluir"
                      >
                        <img src="/icons/delete.png" alt="delete" />
                      </button>
                    </div>
                  </div>
                </div>

                <div class="muted" *ngIf="openTasksOf(c, p).length === 0">Sem tasks.</div>
              </div>
            </div>
          </article>
        </section>

        <ng-template #empty>
          <div class="empty">
            Nenhum boneco cadastrado ainda. Clique em <strong>Adicionar Boneco</strong>.
          </div>
        </ng-template>
      </div>
    </section>
  </main>
</div>

<!-- ====== MODAL: Pergunta pós-focus ====== -->
<div class="confirm-overlay" *ngIf="focusPromptOpen">
  <div class="confirm-card">
    <div class="confirm-title">Pergunta rápida</div>
    <div class="confirm-text">
      Você conseguiu concluir a task <strong>{{ focusPromptTaskTitle }}</strong>?
    </div>

    <div class="confirm-actions">
      <button type="button" class="btn confirm-yes" (click)="confirmFocusResult(true)">
        Sim, concluí
      </button>
      <button type="button" class="btn ghost" (click)="confirmFocusResult(false)">
        Não
      </button>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="dailies-page">
    <div class="bg"></div>
    <main class="shell">
      <section class="glass floating">
        <div class="glass-inner">Carregando...</div>
      </section>
    </main>
  </div>
</ng-template>
