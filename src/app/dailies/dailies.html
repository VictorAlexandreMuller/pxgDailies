<div class="dailies-page" *ngIf="db as data; else loading">
  <div class="bg" [style.background-image]="bgStyleStr"></div>

  <!-- NAVBAR FIXA -->
  <header class="topbar topbar-fixed">
    <div class="left">
      <div class="title">PXG Dailies</div>
      <div class="sub">
        <span><strong>Usuário: </strong>{{ data.profile.displayName }}</span>
      </div>
    </div>

    <div class="right">
      <button type="button" class="btn ghost" (click)="exportJsonDownload()">Exportar</button>
      <button type="button" class="btn ghost" (click)="exportJsonClipboard()" style="display: none">
        Exportar (Copiar)
      </button>

      <button
        type="button"
        class="btn ghost"
        (click)="archivedModalOpen = true"
        [disabled]="!hasArchivedForActive()"
        title="Ver tasks arquivadas do boneco ativo"
      >
        Arquivados
      </button>

      <!-- Wallpaper dropdown -->
      <select
        class="btn ghost wallpaper-select"
        [(ngModel)]="selectedWallpaperKey"
        (change)="onWallpaperChange()"
        title="Alterar wallpaper"
      >
        <option *ngFor="let w of wallpapers" [ngValue]="w.key">
          {{ w.label }}
        </option>
      </select>

      <button type="button" class="btn primary" (click)="logout()">Sair</button>
    </div>
  </header>

  <!-- CONTEÚDO (com espaçamento para não ficar por baixo da navbar) -->
  <main class="shell">
    <section class="glass">
      <div class="glass-inner">
        <section class="add">
          <input
            type="text"
            placeholder="Character name..."
            [(ngModel)]="newCharacterName"
            (keyup.enter)="addCharacter()"
          />
          <button type="button" class="btn" (click)="addCharacter()">Adicionar Boneco</button>
        </section>

        <section class="list" *ngIf="data.characters.length; else empty">
          <nav class="tabs">
            <button
              type="button"
              class="tab"
              *ngFor="let c of data.characters"
              [class.active]="c.id === activeCharacterId"
              (click)="selectCharacter(c.id)"
            >
              <img class="tab-character" src="/icons/character.png" alt="character" />
              <span class="tab-name">{{ c.name }}</span>

              <img
                class="tab-delete"
                src="/icons/delete.png"
                alt="delete"
                title="Remover boneco"
                (click)="$event.stopPropagation(); openDeleteCharacterModal(c.id)"
              />
            </button>
          </nav>

          <!-- CARD DO BONECO ATIVO + LISTAS PRÉ-CALCULADAS -->
          <article class="card" *ngIf="vm() as v">
            <div class="columns">
              <div class="col" *ngFor="let p of periods">
                <ng-container *ngIf="v.byPeriod[p] as pv">
                  <div class="col-head">
                    <h3>{{ periodLabel(p) }}</h3>

                    <button
                      type="button"
                      class="icon-btn add-btn"
                      (click)="addTask(v.character.id, p)"
                      title="Adicionar task"
                    >
                      <img src="/icons/add2.png" alt="add" />
                    </button>
                  </div>

                  <!-- CONCLUÍDAS dentro do card do período -->
                  <section
                    class="done-panel done-inside"
                    *ngIf="pv.total"
                    [class.all-done]="pv.allDone"
                  >
                    <button type="button" class="done-toggle" (click)="toggleDonePanel(p)">
                      <span class="caret" [class.open]="donePanelOpen[p]">›</span>
                      <span class="done-title">Concluídas</span>
                      <span class="done-count">{{ pv.doneCount }}/{{ pv.total }}</span>
                    </button>

                    <div class="done-body" *ngIf="donePanelOpen[p]">
                      <!-- Mensagem quando NÃO há concluídas -->
                      <div class="muted" *ngIf="pv.doneCount === 0">
                        {{ noDoneMessage(p) }}
                      </div>

                      <!-- Lista quando HÁ concluídas -->
                      <div class="done-item" *ngFor="let t of pv.done; trackBy: trackByTaskId">
                        <div class="task-row done">
                          <div class="task-title" [title]="t.title">{{ t.title }}</div>

                          <div class="task-actions">
                            <button
                              type="button"
                              class="icon-btn check-btn on"
                              (click)="toggleDone(v.character.id, t.id)"
                            >
                              <span class="check-icon" aria-hidden="true"></span>
                            </button>

                            <button
                              *ngIf="t.origin !== 'system'"
                              type="button"
                              class="icon-btn"
                              (click)="editTask(v.character.id, t.id)"
                            >
                              <img src="/icons/edit.png" alt="edit" />
                            </button>

                            <!-- USER: exclui -->
                            <button
                              *ngIf="t.origin !== 'system'; else archiveBtnDone"
                              type="button"
                              class="icon-btn"
                              (click)="openDeleteTaskModal(v.character.id, t.id)"
                              title="As missões padrões do sistema só poderão ser arquivadas. Já as missões criadas pelo usuário poderão ser Editadas e/ou Excluídas da forma que desejar."
                            >
                              <img src="/icons/delete.png" alt="delete" />
                            </button>

                            <!-- SYSTEM: arquiva -->
                            <ng-template #archiveBtnDone>
                              <button
                                type="button"
                                class="icon-btn"
                                (click)="archiveTask(v.character.id, t.id)"
                                title="As missões padrões do sistema só poderão ser arquivadas. Já as missões criadas pelo usuário poderão ser Editadas e/ou Excluídas da forma que desejar."
                              >
                                <img src="/icons/arquivar.png" alt="arquivar" />
                              </button>
                            </ng-template>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>

                  <!-- TASKS ABERTAS do período -->
                  <div
                    class="task-drop"
                    cdkDropList
                    [cdkDropListData]="pv.open"
                    (cdkDropListDropped)="onDropOpen($event, v.character.id, p)"
                  >
                    <div
                      class="task"
                      *ngFor="let t of pv.open; trackBy: trackByTaskId"
                      cdkDrag
                    >
                      <div class="task-row" [class.doing]="isDoingNow(t)">
                        <div class="task-title" [title]="t.title">{{ t.title }}</div>

                        <div class="task-actions">
                          <button
                            type="button"
                            class="icon-btn check-btn"
                            (click)="toggleDone(v.character.id, t.id)"
                          >
                            <span class="check-icon" aria-hidden="true"></span>
                          </button>

                          <button
                            type="button"
                            class="icon-btn focus-btn"
                            (click)="startFocusCooldown(v.character.id, t)"
                            [disabled]="isFocusCoolingDown(t.id)"
                            title="O modo Foco deve ser utilizado para te ajudar a lembrar dos seus objetivos."
                          >
                            <img src="/icons/focus.png" alt="doing" />

                            <countdown
                              *ngIf="isFocusCoolingDown(t.id)"
                              class="focus-badge"
                              [config]="focusConfig(t.id)"
                              (event)="onFocusCountdownEvent($event, v.character.id, t)"
                            ></countdown>
                          </button>

                          <button
                            *ngIf="t.origin !== 'system'"
                            type="button"
                            class="icon-btn"
                            (click)="editTask(v.character.id, t.id)"
                          >
                            <img src="/icons/edit.png" alt="edit" />
                          </button>

                          <button
                            *ngIf="t.origin !== 'system'; else archiveBtnOpen"
                            type="button"
                            class="icon-btn"
                            (click)="openDeleteTaskModal(v.character.id, t.id)"
                            title="As missões padrões do sistema só poderão ser arquivadas. Já as missões criadas pelo usuário poderão ser Editadas e/ou Excluídas da forma que desejar."
                          >
                            <img src="/icons/delete.png" alt="delete" />
                          </button>

                          <ng-template #archiveBtnOpen>
                            <button
                              type="button"
                              class="icon-btn"
                              (click)="archiveTask(v.character.id, t.id)"
                              title="As missões padrões do sistema só poderão ser arquivadas. Já as missões criadas pelo usuário poderão ser Editadas e/ou Excluídas da forma que desejar."
                            >
                              <img src="/icons/arquivar.png" alt="arquivar" />
                            </button>
                          </ng-template>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="muted" *ngIf="pv.open.length === 0">Sem tasks.</div>
                </ng-container>
              </div>
            </div>
          </article>
        </section>

        <ng-template #empty>
          <div class="empty">Nenhum boneco cadastrado.</div>
        </ng-template>
      </div>
    </section>
  </main>
</div>

<!-- ====== MODAL: Pergunta pós-focus ====== -->
<div class="confirm-overlay" *ngIf="focusPromptOpen">
  <div class="confirm-card">
    <div class="confirm-title">Pergunta rápida</div>
    <div class="confirm-text">
      Você conseguiu concluir a task <strong>{{ focusPromptTaskTitle }}</strong>?
    </div>

    <div class="confirm-actions">
      <button type="button" class="btn confirm-yes" (click)="confirmFocusResult(true)">
        Sim, concluí
      </button>
      <button type="button" class="btn ghost" (click)="confirmFocusResult(false)">Não</button>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="dailies-page">
    <div class="bg" [style.background-image]="bgStyleStr"></div>
    <main class="shell">
      <section class="glass floating">
        <div class="glass-inner">Carregando...</div>
      </section>
    </main>
  </div>
</ng-template>

<!-- ====== MODAL: Arquivados ====== -->
<div class="confirm-overlay" *ngIf="archivedModalOpen">
  <div class="confirm-card">
    <div class="confirm-title">Arquivados</div>

    <div class="muted" *ngIf="archivedTasksOfActive().length === 0">
      Nenhuma task arquivada para este boneco.
    </div>

    <div class="archived-list" *ngIf="archivedTasksOfActive().length">
      <div class="archived-item" *ngFor="let t of archivedTasksOfActive(); trackBy: trackByTaskId">
        <div class="archived-left">
          <div class="archived-name" [title]="t.title">{{ t.title }}</div>
          <div class="archived-meta">{{ periodLabel(t.period) }}</div>
        </div>

        <div class="archived-actions">
          <button type="button" class="btn" (click)="restoreArchivedTask(activeCharacterId!, t.id)">
            Resgatar
          </button>
        </div>
      </div>
    </div>

    <div class="confirm-actions">
      <button type="button" class="btn ghost" (click)="archivedModalOpen = false">Fechar</button>
    </div>
  </div>
</div>

<app-modal-excluir
  [open]="deleteModalOpen"
  [title]="deleteModalTitle"
  [message]="deleteModalMessage"
  [itemLabel]="deleteModalItemLabel"
  [countdownSeconds]="5"
  (cancel)="closeDeleteModal()"
  (confirm)="confirmDeleteModal()"
></app-modal-excluir>
